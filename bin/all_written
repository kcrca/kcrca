#!/bin/zsh

# Check for unwritten vim swap files
# (1) find directories with .swp files in them
swps=(`find . -name '.*.swp' | while read fn; do dirname "$fn"; done | sort -u`)
# (2) look in there for unwritten files
top=${1:-$PWD}
modified=(`
	for dir in $swps; do
		(
			cd $dir 
			vi -r 2>&1 | awk '
				BEGIN { pwd = "'$top'/" }
				/file name: (.*)/ { file = $3 ; sub(pwd, "", file) ; file = substr(file, 1, length(file) - 1) }
				/modified: YES/ { printf("%s", file) }
				/In directory/ { exit }')
	done
`)

if (( $#modified > 0 )); then
	echo '***' Unwritten files:
	ls $modified
	exit 1
fi
