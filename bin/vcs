#!/bin/zsh

autoload -Uz vcs_info

typeset -A prompts
prompts[s]="vcs"
prompts[b]="branch"
prompts[i]="revision"
prompts[c]="staged"
prompts[u]="unstaged"
prompts[R]="dir"
prompts[r]="rep"
prompts[S]="subdir"
prompts[m]="misc"
prompts[a]="action"

typeset -a prompt_opts
for o in ${(k)prompts}; do
    prompt_opts+="-$o"
done
zparseopts -A opts -D -E -K A: p: ${(k)^prompts}=prompt_opts
if [[ ${1[1]} == "-" ]]; then
    (
	echo "Unknown option(s): $*"
	echo Usage: ${0:t} \[ -p prefix -${(k)^prompts} \] \[dir\]
    ) 1>&2
    exit 1
fi

p="$opts[-p]"

func addVar() {
    echo -n "$1"
    if [[ $opts[-A] == "" ]]; then
	echo -n "$2"
    else
	echo -n "$opts[-A][$2]"
    fi
    echo "='%$3';"
}

(( ${+opts[-A]} )) && echo typset -A $opts[-A]\;
for f in "${(@)prompt_opts}"; do
    k=$f[2,2]
    n=$prompts[$k]
    if [[ $f != "-a" ]] then
	fmt=$(addVar "$fmt" "$p$n" $k)"\n"
    else
	actfmt=$(addVar "$actfmt" "$p$n" $k)"\n"
    fi
done
actfmt+="$fmt"
set +x

zstyle ':vcs_info:*' actionformats "$actfmt"
zstyle ':vcs_info:*' formats       "$fmt"

if [[ "$1" != "" ]]; then
    cd $1 || exit 1
fi
vcs_info
echo -n "$vcs_info_msg_0_"
